name: Build Thunderbird XPI

on:
  push:
    branches: [main]
    paths:
      - "thunderbird-remove-extern/**"
      - ".github/workflows/build-xpi.yml"
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  build-xpi:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Build XPI
        id: build
        run: |
          set -euo pipefail
          EXT_DIR="thunderbird-remove-extern"
          VERSION=$(python3 -c "import json; print(json.load(open('thunderbird-remove-extern/manifest.json'))['version'])")
          ARTIFACT_NAME="remove-extern-prefix-${VERSION}.xpi"
          cd "$EXT_DIR"
          zip -r "../$ARTIFACT_NAME" . -x "*.git*" -x "*node_modules*"
          cd ..
          echo "artifact_name=$ARTIFACT_NAME" >> "$GITHUB_OUTPUT"

      - name: Upload XPI
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.build.outputs.artifact_name }}
          path: ${{ steps.build.outputs.artifact_name }}
          if-no-files-found: error

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ steps.build.outputs.artifact_name }}
          generate_release_notes: true
